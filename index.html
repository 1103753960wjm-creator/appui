<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CozyClean v4.0 - æ‰‹è´¦æµ·æŠ¥ç”Ÿæˆå™¨ (ç»“ç®—ä¿®å¤ç‰ˆ)</title>
    <!-- å¼•å…¥é«˜è´¨æ„Ÿå­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@500;700&family=Patrick+Hand&family=Lora:ital,wght@0,400;0,600;1,400&family=Noto+Serif+SC:wght@400;700&family=Courier+Prime&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- è§†è§‰ç³»ç»Ÿ v4.0 --- */
        :root {
            --bg-desk: #E0E0E0;
            --bg-paper: #FDFBF7;
            --bg-office: #F0F2F5;
            --text-primary: #5D4037;
            --accent-red: #B74141;
            --accent-green: #688F4E;
            --accent-gold: #D4A373;
            --accent-tape: #F0E68C;
            --nav-bg: #F9F7F2;
        }

        body {
            background-color: var(--bg-desk);
            display: flex; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0;
            font-family: 'Lora', 'Noto Serif SC', serif;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* æ‰‹æœºå¤–å£³ */
        .mobile-frame {
            width: 390px; height: 844px;
            background-color: var(--bg-paper); border-radius: 50px;
            box-shadow: 0 0 0 12px #333, 0 20px 50px rgba(0,0,0,0.3), inset 0 0 20px rgba(0,0,0,0.05);
            position: relative; overflow: hidden; transition: background-color 0.5s;
            color: var(--text-primary);
        }
        .mobile-frame.mode-office { background-color: var(--bg-office); }

        .notch {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            width: 120px; height: 35px; background: #000; border-radius: 20px; z-index: 999; pointer-events: none;
        }

        .texture-overlay {
            position: absolute; inset: 0; pointer-events: none; z-index: 50; opacity: 0.6;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }

        /* ç»„ä»¶æ ·å¼ */
        .hand-drawn-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s ease-out; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.1)); }
        
        .washi-tape-bar {
            width: 80%; height: 12px; background: rgba(0,0,0,0.05); position: relative; margin: 10px auto;
            mask-image: url("data:image/svg+xml,%3Csvg width='200' height='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0 L200 0 L200 20 L0 20 Z' fill='black'/%3E%3C/svg%3E");
        }
        .washi-tape-fill {
            height: 100%; background: var(--accent-tape); width: 100%; opacity: 0.8;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.5) 5px, rgba(255,255,255,0.5) 10px);
            transition: width 0.5s;
        }

        .mode-carousel { display: flex; gap: 15px; overflow-x: auto; padding: 10px 25px; scrollbar-width: none; }
        .mode-carousel::-webkit-scrollbar { display: none; }
        .mode-ticket {
            flex: 0 0 100px; height: 130px; background: #fff; border: 1px dashed #d1c4b0; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
            transition: all 0.2s; box-shadow: 2px 2px 5px rgba(0,0,0,0.05);
        }
        .mode-ticket.active { background: #FFFDF5; border: 1px solid var(--accent-red); transform: translateY(-5px) rotate(-1deg); box-shadow: 0 8px 15px rgba(183, 65, 65, 0.15); }

        /* å¡ç‰‡æ ·å¼ */
        .card-screenshot {
            width: 300px; height: 520px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 2px;
            position: relative; font-family: 'Courier Prime', monospace; color: #333; display: flex; flex-direction: column; touch-action: none;
        }
        .card-polaroid {
            width: 300px; height: 420px; background: #fff; padding: 12px 12px 60px 12px;
            box-shadow: 0 10px 25px rgba(93, 64, 55, 0.15); transform-origin: 50% 120%; will-change: transform;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='p'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1' numOctaves='1'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23p)' opacity='0.03'/%3E%3C/svg%3E");
            touch-action: none;
        }

        /* å°ç«  */
        .stamp-mark { position: absolute; z-index: 50; opacity: 0; pointer-events: none; mix-blend-mode: multiply; }
        .stamp-shred-style { border: 3px double #2D3748; color: #2D3748; padding: 5px 20px; font-family: 'Courier Prime', monospace; font-weight: bold; letter-spacing: 2px; transform: rotate(-15deg); }

        /* --- v4.0 æµ·æŠ¥ç”Ÿæˆå™¨æ ·å¼ --- */
        .poster-canvas {
            width: 300px; height: 533px; /* 9:16 æ¯”ä¾‹ */
            background-color: #EFE9D9;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative; overflow: hidden;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.2' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.15'/%3E%3C/svg%3E");
        }
        
        .poster-tape {
            position: absolute; width: 60px; height: 15px; background: rgba(255,255,255,0.6);
            backdrop-filter: blur(2px); z-index: 10;
            mask-image: url("data:image/svg+xml,%3Csvg width='100' height='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0 L100 0 L100 20 L0 20 Z' fill='black'/%3E%3C/svg%3E");
        }

        .mood-input {
            width: 90%; background: transparent; border: none; outline: none;
            font-family: 'Patrick Hand', 'Caveat', cursive; font-size: 1.5rem; color: #4A3B32; text-align: center;
            border-bottom: 1px dashed rgba(74, 59, 50, 0.3); padding-bottom: 5px; margin-top: 15px;
        }
        .mood-input::placeholder { color: rgba(74, 59, 50, 0.4); }

        /* ç§å¯†ç”»å»Šç½‘æ ¼ */
        .scrapbook-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .scrapbook-item {
            width: 100%; aspect-ratio: 9/16; background: #eee; border-radius: 8px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); position: relative; cursor: pointer;
        }

        /* --- ç»“ç®—ä¿¡å°ä¸æ”¶æ®æ ·å¼ --- */
        .envelope-stage { pointer-events: none; z-index: 60; }
        .envelope-body {
            width: 300px; height: 200px; background: var(--bg-kraft);
            position: relative; border-radius: 5px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; border-bottom: 2px solid rgba(0,0,0,0.1);
        }
        .envelope-flap {
            position: absolute; top: 0; left: 0; width: 0; height: 0;
            border-left: 150px solid transparent; border-right: 150px solid transparent;
            border-top: 120px solid #C1A378; transform-origin: top; z-index: 5;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .envelope-flap.closed { transform: rotateX(0deg); }
        .envelope-flap.open { transform: rotateX(180deg); }
        
        .confetti { position: absolute; width: 8px; height: 8px; border-radius: 50%; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        
        .summary-receipt {
            background: #fff; width: 320px; padding: 40px 30px; box-shadow: 0 10px 30px rgba(74, 59, 50, 0.1); position: relative; transform: rotate(-1deg);
            background-image: repeating-linear-gradient(#fff, #fff 31px, #e5e5e5 31px, #e5e5e5 32px);
        }
        .summary-receipt::after {
            content: ''; position: absolute; bottom: -15px; left: 0; width: 100%; height: 15px;
            background: linear-gradient(-45deg, transparent 10px, #fff 10px), linear-gradient(45deg, transparent 10px, #fff 10px); background-size: 20px 20px;
        }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å›¾ç‰‡æ”¾å¤§ç¯ç®±æ•ˆæœ */
        #photo-lightbox { backdrop-filter: blur(8px); transition: opacity 0.3s; }
    </style>
</head>
<body>

    <div class="mobile-frame" id="app-frame">
        <div class="notch"></div>
        <div class="texture-overlay"></div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="flex justify-between px-6 pt-3 text-xs font-bold opacity-40 select-none relative z-10">
            <span>22:05</span>
            <div class="flex gap-1">
                <div class="w-4 h-2.5 bg-current rounded-sm"></div>
                <div class="w-0.5 h-1 bg-current rounded-sm mt-0.5"></div>
            </div>
        </div>

        <div id="app-content" class="relative h-full flex flex-col pb-[80px]">
            
            <!-- 1. é¦–é¡µ (Clean) -->
            <div id="page-home" class="flex-1 flex flex-col items-center pt-8 fade-in relative z-20">
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold font-serif text-[#5D4037]">æ™šä¸Šå¥½ï¼Œæ—å°èˆ’</h1>
                    <p class="text-sm font-hand opacity-60">å‡†å¤‡å¥½æ•´ç†å›å¿†äº†å—ï¼Ÿ</p>
                </div>
                <div class="relative w-40 h-40 mb-8">
                    <svg class="absolute inset-0 w-full h-full text-gray-200" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="5,5" /></svg>
                    <svg class="absolute inset-0 w-full h-full text-[#B74141] transform -rotate-90" viewBox="0 0 100 100"><circle id="progress-circle" class="hand-drawn-ring" cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" /></svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="count-display" class="text-4xl font-hand font-bold text-[#5D4037]">50</span>
                        <span class="text-xs opacity-50 font-serif">/ 50 ä½“åŠ›</span>
                    </div>
                </div>
                <div class="w-full mb-6">
                    <div class="mode-carousel">
                        <div class="mode-ticket active" onclick="setMode('blitz', this)"><div class="text-2xl mb-1">âš¡ï¸</div><div class="font-bold text-xs">é—ªç”µæˆ˜</div><div class="text-[9px] opacity-50 uppercase tracking-widest mt-1">-1 ä½“åŠ›</div></div>
                        <div class="mode-ticket" onclick="setMode('screenshot', this)"><div class="text-2xl mb-1">ğŸ“„</div><div class="font-bold text-xs">æˆªå›¾ç²‰ç¢</div><div class="text-[9px] bg-[#688F4E] text-white px-1 rounded mt-1">-0.5 ä½“åŠ›</div></div>
                        <div class="mode-ticket" onclick="setMode('timeline', this)"><div class="text-2xl mb-1">â³</div><div class="font-bold text-xs">æ—¶å…‰æœº</div><div class="text-[9px] bg-black text-white px-1 rounded mt-1">PRO æ— é™</div></div>
                    </div>
                </div>
                <div id="start-btn" class="w-[130px] h-[130px] bg-[#B74141] rounded-[50%] flex items-center justify-center text-white font-hand text-xl shadow-lg cursor-pointer transform transition active:scale-95 border-4 border-[#FDFBF7] z-30">å¼€å§‹<br>æ•´ç†</div>
            </div>

            <!-- 2. æ»‘å¡ç•Œé¢ (Swiper) -->
            <div id="page-swiper" class="absolute inset-0 z-30 bg-transparent hidden flex-col items-center justify-center">
                <div class="absolute top-12 left-0 w-full px-6 flex justify-between items-center z-40">
                    <span onclick="cancelSession()" class="cursor-pointer text-sm font-serif opacity-60 bg-white/50 px-2 rounded">â† é€€å‡º</span>
                    <!-- é«˜å…‰æ§½ä½æç¤º (v4.0 æ–°å¢) -->
                    <span class="font-hand font-bold text-[#D4A373] bg-white/80 px-3 py-1 rounded-full shadow-sm" id="highlight-counter">â­ 0/4</span>
                </div>
                
                <div id="card-stack" class="relative w-full h-full flex items-center justify-center z-20"></div>
                
                <div id="guide-text" class="absolute bottom-6 w-full flex justify-between px-10 font-hand text-lg opacity-40 pointer-events-none z-10">
                    <span class="text-[#B74141]" id="guide-left">â† ä¸¢å¼ƒ</span>
                    <span class="text-[#D4A373] font-bold">â†‘ è£…è£±æµ·æŠ¥</span>
                    <span class="text-[#688F4E]">ä¿ç•™ â†’</span>
                </div>
            </div>

            <!-- 3. æ‰‹è´¦æµ·æŠ¥ç”Ÿæˆå™¨ (The Maker - v4.0 æ ¸å¿ƒ) -->
            <div id="page-maker" class="absolute inset-0 z-50 bg-[#2D2D2D] hidden flex-col items-center pt-14 pb-6 px-4">
                <div class="w-full flex justify-between items-center mb-6 px-2">
                    <span onclick="discardPoster()" class="text-white/60 cursor-pointer text-sm">ä¸¢å¼ƒ</span>
                    <span class="text-white font-hand text-xl tracking-widest">Scrapbook Maker</span>
                    <span class="w-8"></span>
                </div>

                <!-- 9:16 ç”»å¸ƒåŒº -->
                <div id="poster-canvas" class="poster-canvas flex flex-col items-center py-6 px-4">
                    <!-- ç…§ç‰‡æ’ç‰ˆåŒº -->
                    <div id="poster-photos" class="w-full flex-1 relative flex items-center justify-center">
                        <!-- JS åŠ¨æ€æ³¨å…¥æ’ç‰ˆ -->
                    </div>
                    
                    <!-- æ–‡æ¡ˆåŒº -->
                    <div class="w-full flex flex-col items-center mt-4 z-20 relative">
                        <input type="text" class="mood-input" placeholder="å†™ä¸‹æ­¤åˆ»çš„å¿ƒæƒ…...">
                        <div class="text-[10px] text-center opacity-60 font-serif leading-tight mt-4" id="poster-watermark">
                            ä»Šæ—¥æ¸…ç†äº† 12 å¼ åºŸç‰‡ï¼Œé‡Šæ”¾äº† 48MB ç©ºé—´<br>ä½†ç•™ä¸‹äº†æœ€çè´µçš„è¿™ä¸€åˆ»ã€‚<br><span class="font-hand mt-1 block">â€”â€” CozyClean</span>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨æ“ä½œåŒº -->
                <div class="w-full mt-auto flex flex-col gap-3 px-6">
                    <button onclick="savePoster(event)" class="w-full py-3.5 bg-[#D4A373] text-white rounded-xl font-bold font-serif shadow-lg active:scale-95 transition flex justify-center items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        å­˜å…¥ç§å¯†æ‰‹è´¦
                    </button>
                    <div class="flex gap-3">
                        <button onclick="document.getElementById('paywall').classList.remove('hidden')" class="flex-1 py-3 bg-white/10 text-white/80 rounded-xl text-sm font-bold flex justify-center items-center gap-1">
                            <span>å»æ°´å°</span><span class="bg-black text-[#F0E68C] text-[8px] px-1 rounded">PRO</span>
                        </button>
                        <button onclick="alert('è°ƒèµ·ç³»ç»ŸåŸç”Ÿåˆ†äº«é¢æ¿ (Share Sheet)'); startSettlement();" class="flex-1 py-3 bg-white/10 text-white/80 rounded-xl text-sm font-bold">
                            åˆ†äº«åˆ°...
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢ï¼šç»“ç®—ä¸æ”¶æ®é¡µé¢ -->
            <div id="page-summary" class="absolute inset-0 z-[55] bg-[#FDFBF7] hidden flex-col items-center justify-center overflow-hidden">
                <!-- æ”¶æ®åŠ¨æ€æ³¨å…¥ä½ç½® -->
            </div>

            <div id="settlementStage" class="absolute inset-0 flex items-center justify-center hidden pointer-events-none z-[60]">
                <div id="envelope" class="envelope-body transform translate-y-20 opacity-0 transition-all duration-700">
                    <div id="envelopeFlap" class="envelope-flap open"></div>
                    <span class="font-caveat text-white opacity-50 text-2xl z-10 mt-10" style="font-family: 'Caveat';">Archive</span>
                </div>
            </div>

            <!-- 4. ç§å¯†æ‰‹è´¦ç”»å»Š (Tab: Scrapbook) -->
            <div id="page-scrapbook" class="flex-1 hidden flex-col pt-12 fade-in relative z-20 overflow-y-auto bg-[#F9F7F2]">
                <div class="px-6 pb-2 mb-2 sticky top-0 bg-[#F9F7F2]/90 backdrop-blur z-30">
                    <h1 class="text-2xl font-serif text-[#5D4037] font-bold">æˆ‘çš„æ‰‹è´¦æœ¬</h1>
                    <p class="text-xs opacity-50 mt-1">ä»…æ‚¨è‡ªå·±å¯è§ã€‚å·²æ”¶é›† 1 å¼ æµ·æŠ¥ã€‚</p>
                </div>
                <!-- ç€‘å¸ƒæµ/ç½‘æ ¼ -->
                <div class="scrapbook-grid" id="scrapbook-gallery">
                    <!-- é»˜è®¤é¢„ç½®ä¸€å¼ æµ·æŠ¥ -->
                    <div class="scrapbook-item" onclick="openLightbox('https://images.unsplash.com/photo-1544168190-79c11c9e85ee?w=400')">
                        <img src="https://images.unsplash.com/photo-1544168190-79c11c9e85ee?w=400" class="w-full h-full object-cover opacity-90">
                        <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2">
                            <div class="text-white text-[10px] font-hand">Mar 24, 2026</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. æˆ‘çš„é¡µé¢ (Me) -->
            <div id="page-profile" class="flex-1 hidden flex-col pt-12 px-6 fade-in relative z-20 overflow-y-auto">
                <div class="flex items-center gap-4 mb-8">
                    <div class="w-20 h-20 bg-white p-1 shadow-md transform -rotate-3 rounded"><img src="https://images.unsplash.com/photo-1544168190-79c11c9e85ee?auto=format&fit=crop&w=200" class="w-full h-full object-cover"></div>
                    <div>
                        <h2 class="text-2xl font-serif font-bold text-[#5D4037]">æ—å°èˆ’</h2>
                        <div class="mt-2">
                            <span id="badge-free" class="inline-block text-[10px] bg-gray-200 text-gray-500 px-2 py-0.5 rounded-full">å…è´¹ç‰ˆ</span>
                            <span id="badge-pro" class="hidden inline-block text-[10px] bg-black text-[#F0E68C] px-2 py-0.5 rounded-full border border-[#F0E68C]">æ°¸ä¹…ä¼šå‘˜</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center"><div class="text-xs opacity-50 font-serif">å·²é‡Šæ”¾ç©ºé—´</div><div class="text-2xl font-bold font-hand text-[#688F4E]">1.2 GB</div></div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-center"><div class="text-xs opacity-50 font-serif">è¿ç»­æ‰“å¡</div><div class="text-2xl font-bold font-hand text-[#B74141]">12 å¤©</div></div>
                </div>
                <div class="space-y-4">
                    <div class="border-b border-dashed border-[#D2B48C] pb-2 flex justify-between font-hand text-lg cursor-pointer" onclick="switchTab('scrapbook')"><span>æˆ‘çš„æ‰‹è´¦ç”»å»Š</span><span class="opacity-40">â†’</span></div>
                    <div class="border-b border-dashed border-[#D2B48C] pb-2 flex justify-between font-hand text-lg cursor-pointer"><span>å†å²æ¸…ç†æ—¥å¿—</span><span class="opacity-40">â†’</span></div>
                    <div class="border-b border-dashed border-[#D2B48C] pb-2 flex justify-between font-hand text-lg cursor-pointer" onclick="document.getElementById('paywall').classList.remove('hidden')"><span>ä¼šå‘˜ä¸­å¿ƒ</span><span class="opacity-40">â†’</span></div>
                    <div class="border-b border-dashed border-[#D2B48C] pb-2 flex justify-between font-hand text-lg cursor-pointer"><span>åå¥½è®¾ç½®</span><span class="opacity-40">â†’</span></div>
                </div>
            </div>

            <!-- ä»˜è´¹å¼¹çª— -->
            <div id="paywall" class="absolute inset-0 z-[200] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-6">
                <div class="bg-[#FFFBF0] w-full max-w-sm p-6 rounded-2xl shadow-2xl relative text-center">
                    <div class="text-4xl mb-2">ğŸ‘‘</div><h3 class="text-xl font-bold font-serif mb-2">å‡çº§ Pro ä¼šå‘˜</h3>
                    <ul class="text-sm opacity-70 font-serif mb-6 text-left space-y-2 inline-block">
                        <li>âœ¨ è§£é”ã€Œæ—¶å…‰ç©¿æ¢­æœºã€æ¨¡å¼</li>
                        <li>âœ¨ æ— é™æ¸…ç†ä½“åŠ›</li>
                        <li>âœ¨ æ‰‹è´¦æµ·æŠ¥å»é™¤æ°´å°</li>
                        <li>âœ¨ è§£é”é«˜çº§æ’ç‰ˆæ¨¡æ¿</li>
                    </ul>
                    <button onclick="unlockPro()" class="w-full py-3 bg-[#5D4037] text-white rounded-xl font-bold shadow-lg mb-3">ç«‹å³è§£é”</button>
                    <button onclick="document.getElementById('paywall').classList.add('hidden')" class="text-xs opacity-50 underline">ä»¥åå†è¯´</button>
                </div>
            </div>

            <!-- ç…§ç‰‡æ”¾å¤§ç¯ç®±å±‚ -->
            <div id="photo-lightbox" class="absolute inset-0 z-[1000] bg-black/90 hidden flex-col items-center justify-center">
                <div class="absolute top-14 right-6 text-white opacity-70 p-2 cursor-pointer" onclick="closeLightbox()">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
                <!-- æ¨¡æ‹Ÿç”Ÿæˆçš„é•¿å›¾æµ·æŠ¥æ”¾å¤§æ•ˆæœ -->
                <div id="lightbox-content" class="w-[85%] max-h-[80vh] bg-[#EFE9D9] rounded-lg shadow-2xl overflow-hidden relative">
                     <img id="lightbox-img" src="" class="w-full h-full object-cover">
                     <div class="absolute bottom-4 w-full text-center font-hand text-white text-sm drop-shadow-md">CozyClean</div>
                </div>
            </div>

        </div> 

        <!-- åº•éƒ¨ Tab -->
        <nav class="absolute bottom-0 w-full h-[80px] bg-[#F9F7F2] border-t border-black/5 flex justify-around items-center pb-5 z-40">
            <div id="tab-home" class="opacity-100 text-[#B74141] flex flex-col items-center cursor-pointer transition-all" onclick="switchTab('home')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span class="text-[10px] font-serif mt-1">æ¸…ç†</span>
            </div>
            <!-- Tab B æ”¹ä¸ºæ‰‹è´¦ Scrapbook -->
            <div id="tab-scrapbook" class="opacity-40 flex flex-col items-center cursor-pointer transition-all" onclick="switchTab('scrapbook')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="14" x2="23" y2="14"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="14" x2="4" y2="14"></line></svg>
                <span class="text-[10px] font-serif mt-1">æ‰‹è´¦</span>
            </div>
            <div id="tab-me" class="opacity-40 flex flex-col items-center cursor-pointer transition-all" onclick="switchTab('profile')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span class="text-[10px] font-serif mt-1">æˆ‘çš„</span>
            </div>
        </nav>
    </div>

    <script>
        const state = { 
            energy: 50, 
            deletedInSession: 0,
            isPro: false, 
            mode: 'blitz', 
            highlightImgs: [] // æœ€å¤§é•¿åº¦ 4
        };

        const photos = [
            { src: 'https://images.unsplash.com/photo-1519689680058-324335c77eba?auto=format&fit=crop&w=400&q=80', date: 'å®å®çš„ç¬¬ä¸€æ­¥', type: 'photo' },
            { src: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=400&q=80', date: 'æ™´æœ—çš„å‘¨æ—¥', type: 'photo' },
            { src: 'https://images.unsplash.com/photo-1544168190-79c11c9e85ee?auto=format&fit=crop&w=400&q=80', date: 'å¤§ç¬‘çš„è„¸åº', type: 'photo' },
            { src: 'https://images.unsplash.com/photo-1611162617474-5b21e879e113?auto=format&fit=crop&w=400&q=80', date: '2023-10-12 14:30', info: 'WeChat_2023...jpg', size: '2.4MB', type: 'screenshot' }
        ];

        function switchTab(tab) {
            ['page-home', 'page-scrapbook', 'page-profile', 'page-swiper', 'page-maker', 'page-summary'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`page-${tab}`).classList.remove('hidden');
            
            ['home', 'scrapbook', 'me'].forEach(t => {
                const el = document.getElementById(`tab-${t === 'profile' ? 'me' : t}`);
                if(t === tab || (tab==='profile' && t==='me')) {
                    el.classList.replace('opacity-40', 'opacity-100');
                    el.classList.add('text-[#B74141]');
                } else {
                    el.classList.replace('opacity-100', 'opacity-40');
                    el.classList.remove('text-[#B74141]');
                }
            });
        }

        function setMode(mode, el) {
            if(mode === 'timeline' && !state.isPro) { document.getElementById('paywall').classList.remove('hidden'); return; }
            state.mode = mode;
            document.querySelectorAll('.mode-ticket').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        function unlockPro() {
            state.isPro = true;
            document.getElementById('paywall').classList.add('hidden');
            document.getElementById('badge-free').classList.add('hidden');
            document.getElementById('badge-pro').classList.remove('hidden');
            // è§£é”æ°´å°
            document.getElementById('poster-watermark').innerHTML = `<span class="font-hand opacity-50">è®°å½•æœ€çè´µçš„ä¸€åˆ»ã€‚</span>`;
            alert("âœ¨ ä¼šå‘˜å·²è§£é”ï¼æµ·æŠ¥æ°´å°å·²å»é™¤ã€‚");
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            if (state.energy <= 0) { alert("ä»Šæ—¥ä½“åŠ›å·²è€—å°½ï¼"); return; }
            document.getElementById('page-home').classList.add('hidden');
            document.getElementById('page-swiper').classList.remove('hidden');
            document.querySelector('nav').classList.add('hidden');
            
            state.highlightImgs = [];
            state.deletedInSession = 0;
            document.getElementById('highlight-counter').innerText = `â­ 0/4`;
            
            initCards();
        });

        function goHome() {
            ['page-swiper', 'page-summary', 'page-maker'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('page-home').classList.remove('hidden');
            document.querySelector('nav').classList.remove('hidden');
            document.getElementById('count-display').innerText = state.energy;
            // ç®€å•çš„å€’åºè¿›åº¦æ¡æ¨¡æ‹Ÿ
            document.getElementById('progress-circle').style.strokeDashoffset = 283 - ((50-state.energy) / 50) * 283;
        }

        function cancelSession() {
            if(confirm("ç¡®å®šè¦é€€å‡ºæœ¬æ¬¡æ¸…ç†å—ï¼Ÿè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚")) {
                goHome();
            }
        }

        function initCards() {
            const container = document.getElementById('card-stack');
            container.innerHTML = '';
            let sessionPhotos = state.mode === 'screenshot' ? photos.filter(p => p.type === 'screenshot') : photos.filter(p => p.type === 'photo');
            if(sessionPhotos.length < 5) sessionPhotos = [...sessionPhotos, ...sessionPhotos, ...sessionPhotos];

            sessionPhotos.forEach((p, i) => {
                const card = document.createElement('div');
                const isScreenshot = state.mode === 'screenshot';
                card.className = `absolute top-1/2 left-1/2 flex flex-col items-center cursor-grab active:cursor-grabbing ${isScreenshot ? 'card-screenshot' : 'card-polaroid'}`;
                card.style.transform = `translate(-50%, -50%) rotate(${isScreenshot ? 0 : Math.random()*4-2}deg)`;
                card.style.zIndex = 100 - i;
                card.dataset.src = p.src; 
                
                if (isScreenshot) {
                    card.innerHTML = `
                        <div class="flex-1 w-full overflow-hidden p-4"><img src="${p.src}" class="w-full h-full object-contain pointer-events-none border border-gray-200"></div>
                        <div class="stamp-mark top-24 right-8 opacity-0 stamp-del stamp-shred-style">SHREDDED</div>
                        <div class="stamp-mark bottom-20 left-8 transform rotate-12 border-4 border-[#688F4E] text-[#688F4E] p-2 rounded-full font-hand font-bold text-xl opacity-0 stamp-keep">KEEP</div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="flex-1 w-full overflow-hidden relative bg-gray-100"><img src="${p.src}" class="w-full h-full object-cover pointer-events-none"></div>
                        <div class="py-4 font-hand text-xl opacity-70">${p.date}</div>
                        <div class="stamp-mark top-12 right-8 transform -rotate-12 border-4 border-[#B74141] text-[#B74141] p-2 rounded font-hand font-bold text-xl opacity-0 stamp-del">DISCARD</div>
                        <div class="stamp-mark bottom-20 left-8 transform rotate-12 border-4 border-[#688F4E] text-[#688F4E] p-2 rounded-full font-hand font-bold text-xl opacity-0 stamp-keep">KEEP</div>
                        <!-- v4.0 é«˜å…‰è£…è£±å°ç«  -->
                        <div class="stamp-mark top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-[#D4A373] opacity-0 stamp-hl drop-shadow-lg">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                        </div>
                    `;
                }
                container.appendChild(card);
                if(i === 0) setupSwipe(card);
            });
        }

        function setupSwipe(card) {
            let startX = 0, startY = 0, currentX = 0, currentY = 0, isDragging = false;
            const thresholdX = 100;
            const thresholdY = -100; 

            const sDel = card.querySelector('.stamp-del');
            const sKeep = card.querySelector('.stamp-keep');
            const sHl = card.querySelector('.stamp-hl'); // Highlight star

            const start = (e) => { 
                isDragging = true; startX = e.clientX || e.touches[0].clientX; startY = e.clientY || e.touches[0].clientY; card.style.transition = 'none'; 
            };
            
            const move = (e) => {
                if(!isDragging) return;
                currentX = (e.clientX || e.touches[0].clientX) - startX;
                currentY = (e.clientY || e.touches[0].clientY) - startY;
                
                const isVertical = Math.abs(currentY) > Math.abs(currentX) * 0.5 && currentY < 0;

                if (isVertical && sHl) {
                    card.style.transform = `translate(calc(-50% + ${currentX*0.2}px), calc(-50% + ${currentY}px)) rotate(0deg)`;
                    sHl.style.opacity = Math.min(Math.abs(currentY)/100, 1);
                    sHl.style.transform = `translate(-50%, -50%) scale(${0.5 + Math.min(Math.abs(currentY)/100, 1)})`;
                    if(sDel) sDel.style.opacity = 0; if(sKeep) sKeep.style.opacity = 0;
                } else {
                    const rot = state.mode === 'screenshot' ? 0 : currentX * 0.1;
                    card.style.transform = `translate(calc(-50% + ${currentX}px), -50%) rotate(${rot}deg)`;
                    if(sHl) sHl.style.opacity = 0;
                    if(currentX < 0) {
                        if(sDel) sDel.style.opacity = Math.min(-currentX/thresholdX, 1);
                        if(sKeep) sKeep.style.opacity = 0;
                    } else {
                        if(sKeep) sKeep.style.opacity = Math.min(currentX/thresholdX, 1);
                        if(sDel) sDel.style.opacity = 0;
                    }
                }
            };
            
            const end = () => {
                if(!isDragging) return; isDragging = false;
                const isVertical = Math.abs(currentY) > Math.abs(currentX) * 0.5 && currentY < 0;

                if (isVertical && currentY < thresholdY && sHl) {
                    // v4.0 ä¸Šæ»‘ï¼šåŠ å…¥é«˜å…‰ç´ æåº“ (é™4å¼ )
                    if (state.highlightImgs.length >= 4) {
                        alert("æ¯å±€æœ€å¤šåªèƒ½è£…è£± 4 å¼ é«˜å…‰ç…§ç‰‡å“¦ï¼");
                        card.style.transition = 'transform 0.3s ease';
                        card.style.transform = `translate(-50%, -50%) rotate(0deg)`;
                        sHl.style.opacity = 0;
                        return;
                    }

                    state.highlightImgs.push(card.dataset.src);
                    document.getElementById('highlight-counter').innerText = `â­ ${state.highlightImgs.length}/4`;
                    
                    card.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    // é£å‘å³ä¸Šè§’ç¼©å°
                    card.style.transform = `translate(100px, -400px) scale(0.2) rotate(15deg)`;
                    card.style.opacity = '0';
                    
                    setTimeout(() => processNextCard(card), 400);
                }
                else if(!isVertical && Math.abs(currentX) > thresholdX) {
                    const isDel = currentX < 0;
                    card.style.transition = 'transform 0.4s ease-out';
                    card.style.transform = `translate(calc(-50% + ${isDel ? -500 : 500}px), -50%) rotate(${isDel ? -45 : 45}deg)`;
                    if(isDel) state.deletedInSession++;
                    setTimeout(() => processNextCard(card), 300);
                } else {
                    card.style.transition = 'transform 0.3s ease';
                    card.style.transform = `translate(-50%, -50%) rotate(0deg)`;
                    if(sDel) sDel.style.opacity = 0; if(sKeep) sKeep.style.opacity = 0; if(sHl) sHl.style.opacity = 0;
                }
            };

            card.addEventListener('touchstart', start); window.addEventListener('touchmove', move); window.addEventListener('touchend', end);
            card.addEventListener('mousedown', start); window.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
        }

        function processNextCard(card) {
            state.energy = Math.max(0, state.energy - (state.mode === 'screenshot' ? 0.5 : 1));
            card.remove();
            const next = document.getElementById('card-stack').firstElementChild;
            if(next) {
                setupSwipe(next);
            } else {
                // å¦‚æœæœ‰é«˜å…‰ç…§ç‰‡ï¼Œè¿›å…¥æµ·æŠ¥ç”Ÿæˆå™¨ï¼›å¦åˆ™ç›´æ¥è¿›å…¥ç»“ç®—ä»ªå¼
                if (state.highlightImgs.length > 0) {
                    openPosterMaker();
                } else {
                    startSettlement();
                }
            }
        }

        // --- ç»“ç®—åŠ¨ç”»ä¸æ”¶æ®é€»è¾‘ ---
        function startSettlement() {
            // éšè—å…¶å®ƒé¡µé¢ï¼Œæ˜¾ç¤ºç»“ç®—æ”¶æ®å®¹å™¨
            ['page-home', 'page-scrapbook', 'page-profile', 'page-swiper', 'page-maker'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('page-summary').classList.remove('hidden');
            document.getElementById('page-summary').innerHTML = ''; // æ¸…ç©ºä¸Šæ¬¡è®°å½•
            document.querySelector('nav').classList.add('hidden');

            const stage = document.getElementById('settlementStage');
            const envelope = document.getElementById('envelope');
            stage.classList.remove('hidden');
            
            // é‡ç½®ä¿¡å°çŠ¶æ€
            envelope.classList.add('opacity-0', 'translate-y-20');
            document.getElementById('envelopeFlap').classList.remove('closed');
            document.getElementById('envelopeFlap').classList.add('open');

            // ä¿¡å°è¿›å…¥
            setTimeout(() => {
                envelope.classList.remove('opacity-0', 'translate-y-20');
            }, 100);

            // å»¶è¿Ÿåç›–ä¸Šä¿¡å°ï¼Œå±•ç¤ºæ”¶æ®
            setTimeout(() => {
                document.getElementById('envelopeFlap').classList.remove('open');
                document.getElementById('envelopeFlap').classList.add('closed');
                setTimeout(() => showSummary(), 1000);
            }, 1200);
        }

        function showSummary() {
            document.getElementById('settlementStage').classList.add('hidden');
            createConfetti();
            
            const mbSaved = (state.deletedInSession * 3.5).toFixed(1);
            
            const div = document.createElement('div');
            div.className = 'flex flex-col items-center animate-fade-in z-50';
            div.innerHTML = `
                <div class="summary-receipt mb-8">
                    <h2 class="text-2xl mb-6 border-b border-dashed border-gray-300 pb-2 font-serif font-bold text-[#5D4037]">æ•´ç†å°ç»“</h2>
                    <div class="flex justify-between py-2 text-xl font-hand text-[#5D4037]"><span>å·²ä¸¢å¼ƒåºŸç‰‡</span><span>${state.deletedInSession} å¼ </span></div>
                    <div class="flex justify-between py-2 text-xl font-hand text-[#5D4037]"><span>é‡Šæ”¾ç©ºé—´</span><span>${mbSaved} MB</span></div>
                    <div class="flex justify-between py-2 text-xl font-hand text-[#5D4037]"><span>é«˜å…‰è£…è£±</span><span>${state.highlightImgs.length} å¼ </span></div>
                    <p class="mt-6 text-center text-sm opacity-40 italic font-serif">- è°¢è°¢ä½ ï¼Œä»Šå¤©ä¹Ÿå¾ˆåŠªåŠ› -</p>
                </div>
                <button onclick="finishSession()" class="px-10 py-3 rounded-full text-white text-xl shadow-lg bg-[#A84A4A] font-hand active:scale-95 transition">å®Œæˆ</button>
            `;
            document.getElementById('page-summary').appendChild(div);
        }

        function createConfetti() {
            const colors = ['#A84A4A', '#688F4E', '#D4A373'];
            const container = document.getElementById('page-summary');
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti z-40';
                c.style.background = colors[Math.floor(Math.random()*colors.length)];
                c.style.left = Math.random()*100 + '%';
                c.style.animationDuration = (Math.random()*2 + 2) + 's';
                container.appendChild(c);
            }
        }

        function finishSession() {
            document.querySelectorAll('.confetti').forEach(e => e.remove());
            goHome(); // é‡ç½®å¹¶å›åˆ°é¦–é¡µ
        }

        // --- v4.0 æ‰‹è´¦æµ·æŠ¥ç”Ÿæˆå™¨é€»è¾‘ ---
        function openPosterMaker() {
            document.getElementById('page-swiper').classList.add('hidden');
            document.getElementById('page-maker').classList.remove('hidden');
            
            if(!state.isPro) {
                const mbSaved = (state.deletedInSession * 3.5).toFixed(1);
                document.getElementById('poster-watermark').innerHTML = `ä»Šæ—¥æ¸…ç†äº† ${state.deletedInSession} å¼ åºŸç‰‡ï¼Œé‡Šæ”¾äº† ${mbSaved}MB ç©ºé—´<br>ä½†ç•™ä¸‹äº†æœ€çè´µçš„è¿™ä¸€åˆ»ã€‚<br><span class="font-hand mt-1 block">â€”â€” CozyClean</span>`;
            }

            renderPosterCanvas();
        }

        function renderPosterCanvas() {
            const container = document.getElementById('poster-photos');
            container.innerHTML = '';
            const imgs = state.highlightImgs;
            const count = imgs.length;

            if (count === 1) {
                container.innerHTML = `
                    <div class="w-[85%] bg-white p-3 pb-10 shadow-md transform -rotate-2 relative">
                        <div class="poster-tape -top-2 left-1/2 transform -translate-x-1/2 rotate-3"></div>
                        <img src="${imgs[0]}" class="w-full aspect-[4/5] object-cover border border-gray-100">
                    </div>`;
            } else if (count === 2) {
                container.innerHTML = `
                    <div class="w-[70%] bg-white p-2 pb-6 shadow-md transform -rotate-6 absolute top-[10%] left-[10%] z-10">
                        <div class="poster-tape -top-2 right-2 transform rotate-12"></div>
                        <img src="${imgs[0]}" class="w-full aspect-square object-cover">
                    </div>
                    <div class="w-[70%] bg-white p-2 pb-6 shadow-md transform rotate-4 absolute bottom-[20%] right-[10%] z-20">
                        <img src="${imgs[1]}" class="w-full aspect-square object-cover">
                    </div>`;
            } else {
                let gridHTML = `<div class="grid grid-cols-2 gap-3 p-4 w-full relative z-10"><div class="poster-tape -top-2 left-4 transform rotate-2"></div>`;
                imgs.forEach((src, idx) => {
                    const rot = (idx % 2 === 0) ? -2 : 3;
                    gridHTML += `<div class="bg-white p-1 pb-4 shadow-sm transform rotate-[${rot}deg]"><img src="${src}" class="w-full aspect-square object-cover"></div>`;
                });
                gridHTML += `</div>`;
                container.innerHTML = gridHTML;
            }
        }

        function discardPoster() {
            if(confirm("ç¡®å®šä¸¢å¼ƒè¿™å¼ æµ·æŠ¥å—ï¼Ÿä¸ä¼šä¿å­˜åˆ°æ‰‹è´¦ã€‚")) {
                startSettlement(); // ä¸¢å¼ƒåä¾ç„¶æ­£å¸¸ç»“ç®—
            }
        }

        function savePoster(event) {
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<span class="animate-pulse">ç”Ÿæˆä¸­...</span>`;
            
            setTimeout(() => {
                // ä¿å­˜æµ·æŠ¥å°é¢è‡³ç”»å»Š
                const cover = state.highlightImgs[0];
                const gallery = document.getElementById('scrapbook-gallery');
                const newEl = document.createElement('div');
                newEl.className = 'scrapbook-item fade-in';
                newEl.innerHTML = `
                    <img src="${cover}" class="w-full h-full object-cover opacity-90" onclick="openLightbox('${cover}')">
                    <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-2">
                        <div class="text-white text-[10px] font-hand">Just Now</div>
                    </div>
                `;
                gallery.insertBefore(newEl, gallery.firstChild); 
                
                btn.innerHTML = originalHTML; // é‡ç½®æŒ‰é’®çŠ¶æ€
                startSettlement(); // ä¿å­˜æˆåŠŸåï¼Œæ­£å¸¸è¿›å…¥ä¿¡å°ç»“ç®—ä»ªå¼
            }, 1000);
        }

        // --- å›¾ç‰‡ç¯ç®±é€»è¾‘ ---
        function openLightbox(src) {
            const lightbox = document.getElementById('photo-lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = src;
            lightbox.classList.remove('hidden');
            lightbox.classList.add('flex');
            
            const content = document.getElementById('lightbox-content');
            content.style.transform = 'scale(0.9)';
            setTimeout(() => { content.style.transform = 'scale(1)'; content.style.transition = 'transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; }, 10);
        }

        function closeLightbox() {
            const lightbox = document.getElementById('photo-lightbox');
            lightbox.classList.add('hidden');
            lightbox.classList.remove('flex');
            document.getElementById('lightbox-content').style.transition = 'none';
        }

    </script>
</body>
</html>
